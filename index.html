<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Table Reference System Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root{--bg:#0a0a0f;--surface:#12121a;--surface2:#1a1a25;--accent:#6366f1;--accent2:#8b5cf6;--accent3:#06b6d4;--accent4:#10b981;--text:#e4e4e7;--text-dim:#71717a;--border:#27272a;--glow:rgba(99,102,241,0.4);--success:#22c55e;--warn:#f59e0b;--danger:#ef4444}
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Outfit',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;background-image:radial-gradient(ellipse at 50% 0%,rgba(99,102,241,0.12) 0%,transparent 50%),radial-gradient(ellipse at 80% 80%,rgba(139,92,246,0.08) 0%,transparent 40%)}
        .container{max-width:1400px;margin:0 auto;padding:30px 20px}
        header{text-align:center;margin-bottom:30px}
        h1{font-size:clamp(1.8rem,4vw,2.5rem);font-weight:700;background:linear-gradient(135deg,var(--accent),var(--accent2),var(--accent3));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
        .subtitle{color:var(--text-dim);margin-top:6px;font-weight:300}
        .global-search{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:16px 20px;margin-bottom:20px;position:sticky;top:10px;z-index:200;backdrop-filter:blur(10px)}
        .search-row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
        .search-input-wrap{flex:1;min-width:250px;position:relative}
        .search-input-wrap input{width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:12px 16px 12px 44px;color:var(--text);font-size:.95rem;font-family:inherit;transition:all .2s}
        .search-input-wrap input:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px var(--glow)}
        .search-input-wrap svg{position:absolute;left:14px;top:50%;transform:translateY(-50%);color:var(--text-dim)}
        .search-stats{display:flex;gap:16px;align-items:center;font-size:.9rem;color:var(--text-dim)}
        .search-stats span{background:var(--surface2);padding:6px 12px;border-radius:8px}
        .search-stats .count{color:var(--accent3);font-weight:600}
        .search-nav{display:flex;gap:6px}
        .search-nav button{background:var(--surface2);border:1px solid var(--border);color:var(--text);width:36px;height:36px;border-radius:8px;cursor:pointer;transition:all .15s;display:flex;align-items:center;justify-content:center}
        .search-nav button:hover:not(:disabled){background:var(--accent);border-color:var(--accent)}
        .search-nav button:disabled{opacity:.4;cursor:not-allowed}
        .highlight-match{background:rgba(251,191,36,0.4);color:#fbbf24;border-radius:3px;padding:0 2px}
        .highlight-current{background:rgba(34,197,94,0.5);color:#22c55e;outline:2px solid var(--success)}
        .filter-ribbon{background:var(--surface);border:1px solid var(--border);border-radius:16px;margin-bottom:20px;overflow:hidden}
        .ribbon-header{display:flex;justify-content:space-between;align-items:center;padding:14px 20px;cursor:pointer;background:linear-gradient(135deg,rgba(99,102,241,0.1),rgba(139,92,246,0.1));transition:background .2s}
        .ribbon-header:hover{background:linear-gradient(135deg,rgba(99,102,241,0.15),rgba(139,92,246,0.15))}
        .ribbon-header h3{font-size:1rem;display:flex;align-items:center;gap:10px}
        .ribbon-header h3 svg{color:var(--accent)}
        .ribbon-toggle{background:var(--surface2);border:none;color:var(--text);width:32px;height:32px;border-radius:8px;cursor:pointer;transition:transform .3s}
        .ribbon-toggle.open{transform:rotate(180deg)}
        .ribbon-content{max-height:0;overflow:hidden;transition:max-height .3s ease}
        .ribbon-content.open{max-height:600px}
        .ribbon-inner{padding:20px;display:flex;flex-direction:column;gap:16px}
        .filter-group{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
        .filter-group label{font-size:.85rem;color:var(--text-dim);min-width:80px}
        .filter-input{background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:10px 14px;color:var(--text);font-family:inherit;font-size:.9rem;flex:1;min-width:150px}
        .filter-input:focus{outline:none;border-color:var(--accent)}
        .filter-select{background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:10px 14px;color:var(--text);font-family:inherit;cursor:pointer;min-width:100px}
        .logic-btns{display:flex;gap:6px}
        .logic-btn{background:var(--surface2);border:1px solid var(--border);color:var(--text-dim);padding:8px 14px;border-radius:8px;cursor:pointer;font-size:.85rem;font-weight:500;transition:all .15s}
        .logic-btn.active{background:var(--accent);border-color:var(--accent);color:#fff}
        .logic-btn:hover:not(.active){border-color:var(--accent)}
        .btn{background:linear-gradient(135deg,var(--accent),var(--accent2));border:none;color:#fff;padding:10px 18px;border-radius:10px;cursor:pointer;font-family:inherit;font-weight:500;font-size:.9rem;transition:all .2s;display:inline-flex;align-items:center;gap:8px}
        .btn:hover{transform:translateY(-2px);box-shadow:0 6px 20px var(--glow)}
        .btn-secondary{background:var(--surface2);border:1px solid var(--border)}
        .btn-secondary:hover{border-color:var(--accent);box-shadow:none;transform:none}
        .btn-danger{background:linear-gradient(135deg,var(--danger),#dc2626)}
        .btn-success{background:linear-gradient(135deg,var(--accent4),#059669)}
        .btn-sm{padding:8px 12px;font-size:.85rem}
        .filter-tag{background:var(--surface);border:1px solid var(--border);padding:6px 12px;border-radius:8px;font-size:.85rem;display:inline-flex;align-items:center;gap:8px}
        .filter-tag .remove{cursor:pointer;color:var(--danger);font-weight:bold}
        .controls-bar{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-bottom:16px}
        .dropdown{position:relative}
        .dropdown>button{background:var(--surface2);border:1px solid var(--border);color:var(--text);padding:10px 16px;border-radius:10px;cursor:pointer;font-family:inherit;display:flex;align-items:center;gap:8px;transition:all .2s}
        .dropdown>button:hover{border-color:var(--accent)}
        .dropdown-menu{position:absolute;top:calc(100% + 6px);left:0;min-width:260px;background:var(--surface2);border:1px solid var(--border);border-radius:12px;padding:8px;opacity:0;visibility:hidden;transform:translateY(-8px);transition:all .2s;z-index:100;box-shadow:0 16px 40px rgba(0,0,0,.4);max-height:300px;overflow-y:auto}
        .dropdown.open .dropdown-menu{opacity:1;visibility:visible;transform:translateY(0)}
        .dropdown-item{display:flex;align-items:center;gap:12px;padding:10px 12px;border-radius:8px;cursor:pointer;transition:background .15s}
        .dropdown-item:hover{background:var(--surface)}
        .dropdown-item input{accent-color:var(--accent);width:18px;height:18px;cursor:pointer}
        .dropdown-item code{font-family:'JetBrains Mono',monospace;font-size:.75rem;color:var(--accent3);margin-left:auto}
        .card{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:20px;margin-bottom:20px}
        .card h2{font-size:1.1rem;margin-bottom:14px;display:flex;align-items:center;gap:10px}
        .card h2::before{content:'';width:4px;height:18px;background:linear-gradient(var(--accent),var(--accent2));border-radius:2px}
        .ref-section{margin-bottom:16px}
        .ref-section h4{font-size:.8rem;color:var(--accent3);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;font-weight:500}
        .ref-section p{line-height:1.8;color:var(--text-dim);font-size:.95rem}
        .link{color:var(--accent);text-decoration:none;font-family:'JetBrains Mono',monospace;font-size:.85em;background:rgba(99,102,241,.15);padding:2px 8px;border-radius:6px;cursor:pointer;transition:all .15s;border:1px solid transparent}
        .link:hover{background:rgba(99,102,241,.25);border-color:var(--accent);box-shadow:0 0 12px var(--glow)}
        .table-section{display:none;margin-bottom:24px}
        .table-section.visible{display:block}
        .table-filter-ribbon{background:var(--surface2);border:1px solid var(--border);border-radius:12px;margin-bottom:12px;overflow:hidden}
        .table-filter-ribbon .ribbon-header{display:flex;justify-content:space-between;align-items:center;padding:10px 16px;cursor:pointer;background:linear-gradient(135deg,rgba(99,102,241,0.08),rgba(139,92,246,0.08))}
        .table-filter-ribbon .ribbon-header:hover{background:linear-gradient(135deg,rgba(99,102,241,0.12),rgba(139,92,246,0.12))}
        .table-filter-ribbon .ribbon-header h4{font-size:.9rem;display:flex;align-items:center;gap:8px;color:var(--text-dim);font-weight:500}
        .table-filter-ribbon .ribbon-content{max-height:0;overflow:hidden;transition:max-height .3s}
        .table-filter-ribbon .ribbon-content.open{max-height:400px}
        .table-filter-ribbon .ribbon-inner{padding:14px;display:flex;flex-direction:column;gap:12px}
        .filter-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;padding:8px 10px;background:var(--surface);border-radius:8px}
        .filter-row select,.filter-row input{background:var(--bg);border:1px solid var(--border);border-radius:6px;padding:8px 10px;color:var(--text);font-size:.85rem;font-family:inherit}
        .filter-row select{min-width:110px}
        .filter-row input{flex:1;min-width:120px}
        .filter-row .remove-filter{background:transparent;border:none;color:var(--danger);cursor:pointer;padding:4px 8px;font-size:1.1rem}
        .table-header{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px;margin-bottom:12px}
        .table-header h3{font-size:1rem;color:var(--text)}
        .table-meta{display:flex;gap:12px;align-items:center;font-size:.85rem;flex-wrap:wrap}
        .row-count{background:var(--surface2);padding:6px 12px;border-radius:8px;color:var(--text-dim)}
        .row-count span{color:var(--accent3);font-weight:600}
        .table-actions{display:flex;gap:8px;flex-wrap:wrap}
        .export-dropdown{position:relative}
        .export-menu{position:absolute;top:calc(100% + 6px);right:0;min-width:180px;background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:6px;opacity:0;visibility:hidden;transform:translateY(-8px);transition:all .2s;z-index:50}
        .export-dropdown.open .export-menu{opacity:1;visibility:visible;transform:translateY(0)}
        .export-item{padding:10px 14px;border-radius:8px;cursor:pointer;font-size:.9rem;transition:background .15s;display:flex;align-items:center;gap:10px}
        .export-item:hover{background:var(--surface)}
        .export-item code{color:var(--accent3);font-family:'JetBrains Mono',monospace;font-size:.8rem}
        .table-filter-row{display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap}
        .col-filter{flex:1;min-width:100px}
        .col-filter input{width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:8px 12px;color:var(--text);font-size:.85rem;font-family:inherit}
        .col-filter input:focus{outline:none;border-color:var(--accent)}
        .col-filter input::placeholder{color:var(--text-dim)}
        .table-wrap{overflow-x:auto;border-radius:12px;border:1px solid var(--border)}
        table{width:100%;border-collapse:collapse;font-size:.9rem;min-width:400px}
        th,td{padding:12px 16px;text-align:left;border-bottom:1px solid var(--border)}
        th{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff;font-weight:500;cursor:pointer;user-select:none;white-space:nowrap}
        th:hover{background:linear-gradient(135deg,var(--accent2),var(--accent))}
        th .sort-icon{margin-left:6px;opacity:.5;display:inline-block;transition:transform .2s}
        th.sorted .sort-icon{opacity:1}
        th.sorted.asc .sort-icon{transform:rotate(180deg)}
        tr{transition:background .15s}
        tr:hover{background:var(--surface2)}
        tr.highlight{background:rgba(99,102,241,.2)!important}
        tr.filtered-out{display:none}
        td.highlight-cell{background:rgba(139,92,246,.3)!important;box-shadow:inset 0 0 0 2px var(--accent2)}
        .tooltip{position:fixed;background:var(--surface2);color:var(--text);padding:12px 16px;border-radius:10px;font-size:.9rem;max-width:400px;z-index:1000;display:none;border:1px solid var(--border);box-shadow:0 12px 32px rgba(0,0,0,.5)}
        .tooltip-row{color:var(--accent);font-weight:500;margin-bottom:4px}
        .tooltip-col{margin-left:12px;color:var(--text-dim);font-size:.85rem}
        .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);backdrop-filter:blur(4px);z-index:500;display:none;align-items:center;justify-content:center}
        .modal-overlay.active{display:flex}
        .modal{background:var(--surface);border:1px solid var(--border);border-radius:20px;padding:24px;max-width:600px;width:90%;max-height:80vh;overflow-y:auto}
        .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
        .modal-header h3{font-size:1.1rem}
        .modal-close{background:var(--surface2);border:none;color:var(--text);width:36px;height:36px;border-radius:10px;cursor:pointer;font-size:1.2rem;transition:background .15s}
        .modal-close:hover{background:var(--border)}
        .detail-group{background:var(--surface2);padding:14px;border-radius:12px;margin-bottom:10px;border-left:3px solid var(--accent)}
        .detail-group-title{color:var(--accent);font-weight:600;margin-bottom:8px}
        .detail-row{background:var(--surface);padding:8px 12px;border-radius:8px;margin-top:6px}
        .detail-row.highlighted{border:1px solid var(--accent2);background:rgba(139,92,246,.15)}
        .detail-label{color:var(--accent3);font-weight:500}
        .legend{background:var(--surface2);padding:16px;border-radius:12px;margin-top:20px}
        .legend h4{font-size:.9rem;margin-bottom:10px;color:var(--accent3)}
        .legend-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:8px}
        .legend p{font-size:.85rem;color:var(--text-dim);display:flex;align-items:center;gap:8px}
        .legend code{font-family:'JetBrains Mono',monospace;background:var(--surface);padding:3px 8px;border-radius:6px;color:var(--accent);font-size:.8rem}
        .toast{position:fixed;bottom:24px;right:24px;background:var(--surface2);border:1px solid var(--accent4);padding:14px 20px;border-radius:12px;display:flex;align-items:center;gap:12px;z-index:600;transform:translateY(100px);opacity:0;transition:all .3s}
        .toast.show{transform:translateY(0);opacity:1}
        .toast svg{color:var(--accent4)}
        @media(max-width:768px){.search-row,.filter-group{flex-direction:column;align-items:stretch}.search-stats{justify-content:center}.filter-group label{min-width:auto}.table-header{flex-direction:column;align-items:flex-start}}
    </style>
</head>
<body>
<div class="container">
    <header>
        <h1>ðŸ“Š Table Reference System Pro</h1>
        <p class="subtitle">Advanced search, filtering, sorting & export</p>
    </header>
    
    <div class="global-search">
        <div class="search-row">
            <div class="search-input-wrap">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
                <input type="text" id="globalSearch" placeholder="Search entire page... (Ctrl+F)">
            </div>
            <div class="search-stats">
                <span>Matches: <span class="count" id="matchCount">0</span></span>
                <span>Current: <span class="count" id="currentMatch">0</span></span>
            </div>
            <div class="search-nav">
                <button id="prevMatch" disabled><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m18 15-6-6-6 6"/></svg></button>
                <button id="nextMatch" disabled><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m6 9 6 6 6-6"/></svg></button>
            </div>
            <button class="btn btn-secondary btn-sm" id="clearSearch">Clear</button>
        </div>
    </div>
    
    <div class="controls-bar">
        <div class="dropdown" id="tableDropdown">
            <button onclick="toggleDropdown('tableDropdown')">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18M9 21V9"/></svg>
                Select Tables
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m6 9 6 6 6-6"/></svg>
            </button>
            <div class="dropdown-menu" id="tableMenu"></div>
        </div>
    </div>
    
    <div class="card">
        <h2>Reference Examples</h2>
        <div class="ref-section"><h4>Basic (with metadata aliases)</h4><p class="auto-link">R(VR,2) = R(1,2) validation. I(ED,001) = I(2,001) experiment. R(PI,1,2) = R(3,1,2) product.</p></div>
        <div class="ref-section"><h4>Multi-column</h4><p class="auto-link">Row data: I(1,1.0,1+3). Compare: R(ED,1+2,3). Range: R(SD,1-3,2+3). Products: I(PI,P001+P002,2+3).</p></div>
        <div class="ref-section"><h4>Advanced</h4><p class="auto-link">Continuous: I(VR,1.0*2.a,2). All rows: R(2,all,1). Full data: I(EMP,all,all).</p></div>
    </div>
    
    <div class="table-section" id="sec-T1">
        <div class="table-header"><h3>Table 1: Validation Results</h3>
            <div class="table-meta"><span class="row-count">Rows: <span id="count-T1">3</span></span>
                <div class="table-actions">
                    <div class="export-dropdown" id="export-T1"><button class="btn btn-secondary btn-sm" onclick="toggleDropdown('export-T1')"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>Export</button>
                        <div class="export-menu"><div class="export-item" onclick="exportTable('T1','json')"><code>JSON</code></div><div class="export-item" onclick="exportTable('T1','csv')"><code>CSV</code></div><div class="export-item" onclick="exportTable('T1','tsv')"><code>TSV</code></div><div class="export-item" onclick="exportTable('T1','md')"><code>MD</code></div></div></div>
                    <button class="btn btn-secondary btn-sm" onclick="resetTable('T1')">Reset</button></div></div></div>
        <div class="table-filter-ribbon" id="ribbon-T1">
            <div class="ribbon-header" onclick="toggleTableRibbon('T1')"><h4><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>Advanced Filter (SQL-style)</h4><span class="ribbon-toggle" id="toggle-T1">â–¼</span></div>
            <div class="ribbon-content" id="content-T1"><div class="ribbon-inner">
                <div id="filter-rows-T1"></div>
                <div class="filter-group"><button class="btn btn-sm" onclick="addFilterRow('T1')">+ Add Condition</button><button class="btn btn-success btn-sm" onclick="applyTableFilter('T1')">Apply</button><button class="btn btn-danger btn-sm" onclick="resetTable('T1')">Reset</button></div>
            </div></div>
        </div>
        <div class="table-wrap"><table id="T1"><thead><tr><th data-col="0">ID<span class="sort-icon">â†•</span></th><th data-col="1">Text<span class="sort-icon">â†•</span></th><th data-col="2">Status<span class="sort-icon">â†•</span></th><th data-col="3">Remark<span class="sort-icon">â†•</span></th></tr></thead>
        <tbody><tr><td>1.0</td><td>Primary validation completed</td><td>Passed</td><td>All criteria met</td></tr><tr><td>2.a</td><td>Performance metrics improved</td><td>Passed</td><td>20% increase</td></tr><tr><td>3.0.a.P</td><td>Testing phase insights</td><td>Review</td><td>Analysis needed</td></tr></tbody></table></div></div>
    
    <div class="table-section" id="sec-T2">
        <div class="table-header"><h3>Table 2: Experiment Data</h3>
            <div class="table-meta"><span class="row-count">Rows: <span id="count-T2">3</span></span>
                <div class="table-actions">
                    <div class="export-dropdown" id="export-T2"><button class="btn btn-secondary btn-sm" onclick="toggleDropdown('export-T2')"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>Export</button>
                        <div class="export-menu"><div class="export-item" onclick="exportTable('T2','json')"><code>JSON</code></div><div class="export-item" onclick="exportTable('T2','csv')"><code>CSV</code></div><div class="export-item" onclick="exportTable('T2','tsv')"><code>TSV</code></div><div class="export-item" onclick="exportTable('T2','md')"><code>MD</code></div></div></div>
                    <button class="btn btn-secondary btn-sm" onclick="resetTable('T2')">Reset</button></div></div></div>
        <div class="table-filter-ribbon" id="ribbon-T2">
            <div class="ribbon-header" onclick="toggleTableRibbon('T2')"><h4><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>Advanced Filter (SQL-style)</h4><span class="ribbon-toggle" id="toggle-T2">â–¼</span></div>
            <div class="ribbon-content" id="content-T2"><div class="ribbon-inner">
                <div id="filter-rows-T2"></div>
                <div class="filter-group"><button class="btn btn-sm" onclick="addFilterRow('T2')">+ Add Condition</button><button class="btn btn-success btn-sm" onclick="applyTableFilter('T2')">Apply</button><button class="btn btn-danger btn-sm" onclick="resetTable('T2')">Reset</button></div>
            </div></div>
        </div>
        <div class="table-wrap"><table id="T2"><thead><tr><th data-col="0">ID<span class="sort-icon">â†•</span></th><th data-col="1">Text<span class="sort-icon">â†•</span></th><th data-col="2">Result<span class="sort-icon">â†•</span></th><th data-col="3">Remark<span class="sort-icon">â†•</span></th></tr></thead>
        <tbody><tr><td>001</td><td>Promising experimental results</td><td>Positive</td><td>Exceeded by 15%</td></tr><tr><td>002</td><td>Sample requiring verification</td><td>Pending</td><td>Validation scheduled</td></tr><tr><td>003</td><td>Control group baseline</td><td>Stable</td><td>Consistent</td></tr></tbody></table></div></div>
    
    <div class="table-section" id="sec-T3">
        <div class="table-header"><h3>Table 3: Product Inventory</h3>
            <div class="table-meta"><span class="row-count">Rows: <span id="count-T3">5</span></span>
                <div class="table-actions">
                    <div class="export-dropdown" id="export-T3"><button class="btn btn-secondary btn-sm" onclick="toggleDropdown('export-T3')"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>Export</button>
                        <div class="export-menu"><div class="export-item" onclick="exportTable('T3','json')"><code>JSON</code></div><div class="export-item" onclick="exportTable('T3','csv')"><code>CSV</code></div><div class="export-item" onclick="exportTable('T3','tsv')"><code>TSV</code></div><div class="export-item" onclick="exportTable('T3','md')"><code>MD</code></div></div></div>
                    <button class="btn btn-secondary btn-sm" onclick="resetTable('T3')">Reset</button></div></div></div>
        <div class="table-filter-ribbon" id="ribbon-T3">
            <div class="ribbon-header" onclick="toggleTableRibbon('T3')"><h4><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>Advanced Filter (SQL-style)</h4><span class="ribbon-toggle" id="toggle-T3">â–¼</span></div>
            <div class="ribbon-content" id="content-T3"><div class="ribbon-inner">
                <div id="filter-rows-T3"></div>
                <div class="filter-group"><button class="btn btn-sm" onclick="addFilterRow('T3')">+ Add Condition</button><button class="btn btn-success btn-sm" onclick="applyTableFilter('T3')">Apply</button><button class="btn btn-danger btn-sm" onclick="resetTable('T3')">Reset</button></div>
            </div></div>
        </div>
        <div class="table-wrap"><table id="T3"><thead><tr><th data-col="0">SKU<span class="sort-icon">â†•</span></th><th data-col="1">Product<span class="sort-icon">â†•</span></th><th data-col="2">Category<span class="sort-icon">â†•</span></th><th data-col="3">Stock<span class="sort-icon">â†•</span></th><th data-col="4">Price<span class="sort-icon">â†•</span></th></tr></thead>
        <tbody><tr><td>P001</td><td>Wireless Mouse</td><td>Electronics</td><td>150</td><td>$29.99</td></tr><tr><td>P002</td><td>Mechanical Keyboard</td><td>Electronics</td><td>85</td><td>$89.99</td></tr><tr><td>P003</td><td>USB-C Hub</td><td>Accessories</td><td>200</td><td>$45.00</td></tr><tr><td>P004</td><td>Monitor Stand</td><td>Furniture</td><td>45</td><td>$79.99</td></tr><tr><td>P005</td><td>Webcam HD</td><td>Electronics</td><td>120</td><td>$65.00</td></tr></tbody></table></div></div>
    
    <div class="table-section" id="sec-T4">
        <div class="table-header"><h3>Table 4: Sales Data</h3>
            <div class="table-meta"><span class="row-count">Rows: <span id="count-T4">4</span></span>
                <div class="table-actions">
                    <div class="export-dropdown" id="export-T4"><button class="btn btn-secondary btn-sm" onclick="toggleDropdown('export-T4')"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>Export</button>
                        <div class="export-menu"><div class="export-item" onclick="exportTable('T4','json')"><code>JSON</code></div><div class="export-item" onclick="exportTable('T4','csv')"><code>CSV</code></div><div class="export-item" onclick="exportTable('T4','tsv')"><code>TSV</code></div><div class="export-item" onclick="exportTable('T4','md')"><code>MD</code></div></div></div>
                    <button class="btn btn-secondary btn-sm" onclick="resetTable('T4')">Reset</button></div></div></div>
        <div class="table-filter-ribbon" id="ribbon-T4">
            <div class="ribbon-header" onclick="toggleTableRibbon('T4')"><h4><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>Advanced Filter (SQL-style)</h4><span class="ribbon-toggle" id="toggle-T4">â–¼</span></div>
            <div class="ribbon-content" id="content-T4"><div class="ribbon-inner">
                <div id="filter-rows-T4"></div>
                <div class="filter-group"><button class="btn btn-sm" onclick="addFilterRow('T4')">+ Add Condition</button><button class="btn btn-success btn-sm" onclick="applyTableFilter('T4')">Apply</button><button class="btn btn-danger btn-sm" onclick="resetTable('T4')">Reset</button></div>
            </div></div>
        </div>
        <div class="table-wrap"><table id="T4"><thead><tr><th data-col="0">Quarter<span class="sort-icon">â†•</span></th><th data-col="1">Region<span class="sort-icon">â†•</span></th><th data-col="2">Revenue<span class="sort-icon">â†•</span></th><th data-col="3">Growth<span class="sort-icon">â†•</span></th></tr></thead>
        <tbody><tr><td>Q1</td><td>North America</td><td>$1.2M</td><td>+12%</td></tr><tr><td>Q2</td><td>Europe</td><td>$890K</td><td>+8%</td></tr><tr><td>Q3</td><td>Asia Pacific</td><td>$1.5M</td><td>+22%</td></tr><tr><td>Q4</td><td>Latin America</td><td>$650K</td><td>+5%</td></tr></tbody></table></div></div>
    
    <div class="table-section" id="sec-T5">
        <div class="table-header"><h3>Table 5: Employee Directory</h3>
            <div class="table-meta"><span class="row-count">Rows: <span id="count-T5">6</span></span>
                <div class="table-actions">
                    <div class="export-dropdown" id="export-T5"><button class="btn btn-secondary btn-sm" onclick="toggleDropdown('export-T5')"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>Export</button>
                        <div class="export-menu"><div class="export-item" onclick="exportTable('T5','json')"><code>JSON</code></div><div class="export-item" onclick="exportTable('T5','csv')"><code>CSV</code></div><div class="export-item" onclick="exportTable('T5','tsv')"><code>TSV</code></div><div class="export-item" onclick="exportTable('T5','md')"><code>MD</code></div></div></div>
                    <button class="btn btn-secondary btn-sm" onclick="resetTable('T5')">Reset</button></div></div></div>
        <div class="table-filter-ribbon" id="ribbon-T5">
            <div class="ribbon-header" onclick="toggleTableRibbon('T5')"><h4><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>Advanced Filter (SQL-style)</h4><span class="ribbon-toggle" id="toggle-T5">â–¼</span></div>
            <div class="ribbon-content" id="content-T5"><div class="ribbon-inner">
                <div id="filter-rows-T5"></div>
                <div class="filter-group"><button class="btn btn-sm" onclick="addFilterRow('T5')">+ Add Condition</button><button class="btn btn-success btn-sm" onclick="applyTableFilter('T5')">Apply</button><button class="btn btn-danger btn-sm" onclick="resetTable('T5')">Reset</button></div>
            </div></div>
        </div>
        <div class="table-wrap"><table id="T5"><thead><tr><th data-col="0">EmpID<span class="sort-icon">â†•</span></th><th data-col="1">Name<span class="sort-icon">â†•</span></th><th data-col="2">Dept<span class="sort-icon">â†•</span></th><th data-col="3">Role<span class="sort-icon">â†•</span></th><th data-col="4">Status<span class="sort-icon">â†•</span></th></tr></thead>
        <tbody><tr><td>E001</td><td>Alice Johnson</td><td>Engineering</td><td>Senior Dev</td><td>Active</td></tr><tr><td>E002</td><td>Bob Smith</td><td>Marketing</td><td>Manager</td><td>Active</td></tr><tr><td>E003</td><td>Carol White</td><td>Engineering</td><td>Lead Dev</td><td>Active</td></tr><tr><td>E004</td><td>David Brown</td><td>Sales</td><td>Executive</td><td>On Leave</td></tr><tr><td>E005</td><td>Eva Martinez</td><td>HR</td><td>Director</td><td>Active</td></tr><tr><td>E006</td><td>Frank Lee</td><td>Engineering</td><td>Junior Dev</td><td>Active</td></tr></tbody></table></div></div>
    
    <div class="legend"><h4>Reference Syntax</h4>
        <div class="legend-grid">
            <p><code>I(t, id)</code> By ID</p><p><code>R(t, row)</code> By row#</p>
            <p><code>I(t, id, col1+col2)</code> Multi-col</p><p><code>R(t, 1-3, col)</code> Range</p>
            <p><code>I(t, id1*id2, col)</code> Continuous</p><p><code>R(t, all, all)</code> Full table</p>
        </div>
    </div>
</div>

<div class="tooltip" id="tooltip"></div>
<div class="modal-overlay" id="modal" onclick="if(event.target===this)closeModal()">
    <div class="modal"><div class="modal-header"><h3 id="modalTitle">Details</h3><button class="modal-close" onclick="closeModal()">Ã—</button></div><div id="modalContent"></div></div>
</div>
<div class="toast" id="toast"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg><span id="toastMsg"></span></div>

<script>
const $=s=>document.querySelector(s),$$=s=>document.querySelectorAll(s);
let matches=[],currentIdx=-1,sortState={};

// TABLE METADATA - maps aliases to table IDs
const tableMeta={
    'VR':'T1','validation':'T1','T1':'T1','1':'T1',
    'ED':'T2','experiment':'T2','T2':'T2','2':'T2',
    'PI':'T3','product':'T3','inventory':'T3','T3':'T3','3':'T3',
    'SD':'T4','sales':'T4','T4':'T4','4':'T4',
    'EMP':'T5','employee':'T5','directory':'T5','T5':'T5','5':'T5'
};

// GLOBAL SEARCH
function clearHighlights(){$$('.highlight-match,.highlight-current').forEach(el=>{const p=el.parentNode;p.replaceChild(document.createTextNode(el.textContent),el);p.normalize()});}
function highlightMatches(q){
    clearHighlights();matches=[];currentIdx=-1;
    if(!q.trim()){updateSearchUI();return;}
    const regex=new RegExp(`(${q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')})`,'gi');
    const walk=document.createTreeWalker(document.body,NodeFilter.SHOW_TEXT,{acceptNode:n=>n.parentElement.closest('.search-input-wrap,script,style,#tooltip,.modal')?NodeFilter.FILTER_REJECT:NodeFilter.FILTER_ACCEPT});
    const nodes=[];while(walk.nextNode())nodes.push(walk.currentNode);
    nodes.forEach(node=>{
        if(!regex.test(node.textContent))return;regex.lastIndex=0;
        const frag=document.createDocumentFragment();let last=0,m;
        while((m=regex.exec(node.textContent))){
            if(m.index>last)frag.appendChild(document.createTextNode(node.textContent.slice(last,m.index)));
            const span=document.createElement('span');span.className='highlight-match';span.textContent=m[1];
            frag.appendChild(span);matches.push(span);last=m.index+m[0].length;
        }
        if(last<node.textContent.length)frag.appendChild(document.createTextNode(node.textContent.slice(last)));
        node.parentNode.replaceChild(frag,node);
    });
    if(matches.length)goToMatch(0);updateSearchUI();
}
function goToMatch(idx){if(!matches.length)return;matches.forEach(m=>m.classList.remove('highlight-current'));currentIdx=(idx+matches.length)%matches.length;matches[currentIdx].classList.add('highlight-current');matches[currentIdx].scrollIntoView({behavior:'smooth',block:'center'});updateSearchUI();}
function updateSearchUI(){$('#matchCount').textContent=matches.length;$('#currentMatch').textContent=matches.length?currentIdx+1:0;$('#prevMatch').disabled=$('#nextMatch').disabled=!matches.length;}
let searchTO;$('#globalSearch').addEventListener('input',e=>{clearTimeout(searchTO);searchTO=setTimeout(()=>highlightMatches(e.target.value),200);});
$('#prevMatch').onclick=()=>goToMatch(currentIdx-1);$('#nextMatch').onclick=()=>goToMatch(currentIdx+1);
$('#clearSearch').onclick=()=>{$('#globalSearch').value='';clearHighlights();matches=[];updateSearchUI();};
document.addEventListener('keydown',e=>{if(e.ctrlKey&&e.key==='f'){e.preventDefault();$('#globalSearch').focus();}if(document.activeElement===$('#globalSearch')&&e.key==='Enter'){e.shiftKey?goToMatch(currentIdx-1):goToMatch(currentIdx+1);}});

// PER-TABLE ADVANCED FILTERS
const tableFilters={};// {T1:{logic:'AND',conditions:[{col,op,val}]}, ...}

function toggleTableRibbon(tid){
    const content=$(`#content-${tid}`),toggle=$(`#toggle-${tid}`);
    content.classList.toggle('open');
    toggle.textContent=content.classList.contains('open')?'â–²':'â–¼';
}

function getTableHeaders(tid){
    return[...$(`#${tid}`).querySelectorAll('th')].map(h=>h.textContent.replace('â†•','').trim());
}

function addFilterRow(tid){
    if(!tableFilters[tid])tableFilters[tid]={logic:'AND',conditions:[]};
    const headers=getTableHeaders(tid);
    const container=$(`#filter-rows-${tid}`);
    const idx=tableFilters[tid].conditions.length;
    const defaultLogic=idx===0?'':'AND';
    tableFilters[tid].conditions.push({col:0,op:'contains',val:'',logic:defaultLogic});
    const row=document.createElement('div');
    row.className='filter-row';
    row.dataset.idx=idx;
    row.innerHTML=`
        ${idx>0?`<select class="filter-logic" data-tid="${tid}" data-idx="${idx}">
            <option value="AND">AND</option>
            <option value="OR">OR</option>
            <option value="NOT">NOT</option>
        </select>`:'<span style="width:60px;color:var(--accent3);font-weight:500">WHERE</span>'}
        <select class="filter-col" data-tid="${tid}" data-idx="${idx}">${headers.map((h,i)=>`<option value="${i}">${h}</option>`).join('')}</select>
        <select class="filter-op" data-tid="${tid}" data-idx="${idx}">
            <option value="contains">contains</option>
            <option value="equals">equals</option>
            <option value="starts">starts with</option>
            <option value="ends">ends with</option>
            <option value="gt">></option>
            <option value="lt"><</option>
            <option value="gte">>=</option>
            <option value="lte"><=</option>
            <option value="neq">!=</option>
            <option value="empty">is empty</option>
            <option value="notempty">not empty</option>
        </select>
        <input type="text" class="filter-val" placeholder="Value..." data-tid="${tid}" data-idx="${idx}">
        <button class="remove-filter" onclick="removeFilterRow('${tid}',${idx})">Ã—</button>`;
    container.appendChild(row);
    bindFilterRowEvents(row,tid,idx);
}

function bindFilterRowEvents(row,tid,idx){
    const logicSel=row.querySelector('.filter-logic');
    if(logicSel)logicSel.onchange=e=>{tableFilters[tid].conditions[idx].logic=e.target.value;};
    row.querySelector('.filter-col').onchange=e=>{tableFilters[tid].conditions[idx].col=+e.target.value;};
    row.querySelector('.filter-op').onchange=e=>{tableFilters[tid].conditions[idx].op=e.target.value;};
    row.querySelector('.filter-val').oninput=e=>{tableFilters[tid].conditions[idx].val=e.target.value;};
}

function removeFilterRow(tid,idx){
    tableFilters[tid].conditions.splice(idx,1);
    rebuildFilterRows(tid);
}

function rebuildFilterRows(tid){
    const container=$(`#filter-rows-${tid}`);
    container.innerHTML='';
    const headers=getTableHeaders(tid);
    tableFilters[tid].conditions.forEach((cond,idx)=>{
        const row=document.createElement('div');
        row.className='filter-row';
        row.dataset.idx=idx;
        row.innerHTML=`
            ${idx>0?`<select class="filter-logic" data-tid="${tid}" data-idx="${idx}">
                <option value="AND"${cond.logic==='AND'?' selected':''}>AND</option>
                <option value="OR"${cond.logic==='OR'?' selected':''}>OR</option>
                <option value="NOT"${cond.logic==='NOT'?' selected':''}>NOT</option>
            </select>`:'<span style="width:60px;color:var(--accent3);font-weight:500">WHERE</span>'}
            <select class="filter-col" data-tid="${tid}" data-idx="${idx}">${headers.map((h,i)=>`<option value="${i}"${i===cond.col?' selected':''}>${h}</option>`).join('')}</select>
            <select class="filter-op" data-tid="${tid}" data-idx="${idx}">
                <option value="contains"${cond.op==='contains'?' selected':''}>contains</option>
                <option value="equals"${cond.op==='equals'?' selected':''}>equals</option>
                <option value="starts"${cond.op==='starts'?' selected':''}>starts with</option>
                <option value="ends"${cond.op==='ends'?' selected':''}>ends with</option>
                <option value="gt"${cond.op==='gt'?' selected':''}>&gt;</option>
                <option value="lt"${cond.op==='lt'?' selected':''}>&lt;</option>
                <option value="gte"${cond.op==='gte'?' selected':''}>&gt;=</option>
                <option value="lte"${cond.op==='lte'?' selected':''}>&lt;=</option>
                <option value="neq"${cond.op==='neq'?' selected':''}>!=</option>
                <option value="empty"${cond.op==='empty'?' selected':''}>is empty</option>
                <option value="notempty"${cond.op==='notempty'?' selected':''}>not empty</option>
            </select>
            <input type="text" class="filter-val" value="${cond.val}" placeholder="Value..." data-tid="${tid}" data-idx="${idx}">
            <button class="remove-filter" onclick="removeFilterRow('${tid}',${idx})">Ã—</button>`;
        container.appendChild(row);
        bindFilterRowEvents(row,tid,idx);
    });
}

function evalCondition(cellVal,op,filterVal){
    const cv=cellVal.toLowerCase(),fv=filterVal.toLowerCase();
    const cn=parseFloat(cellVal.replace(/[^0-9.-]/g,'')),fn=parseFloat(filterVal);
    switch(op){
        case'contains':return cv.includes(fv);
        case'equals':return cv===fv;
        case'starts':return cv.startsWith(fv);
        case'ends':return cv.endsWith(fv);
        case'gt':return!isNaN(cn)&&!isNaN(fn)&&cn>fn;
        case'lt':return!isNaN(cn)&&!isNaN(fn)&&cn<fn;
        case'gte':return!isNaN(cn)&&!isNaN(fn)&&cn>=fn;
        case'lte':return!isNaN(cn)&&!isNaN(fn)&&cn<=fn;
        case'neq':return cv!==fv;
        case'empty':return cellVal.trim()==='';
        case'notempty':return cellVal.trim()!=='';
        default:return true;
    }
}

function applyTableFilter(tid){
    if(!tableFilters[tid]||!tableFilters[tid].conditions.length){
        $(`#${tid}`).querySelectorAll('tbody tr').forEach(tr=>tr.classList.remove('filtered-out'));
        updateRowCounts();return;
    }
    const conditions=tableFilters[tid].conditions.filter(c=>c.val||c.op==='empty'||c.op==='notempty');
    $(`#${tid}`).querySelectorAll('tbody tr').forEach(tr=>{
        if(!conditions.length){tr.classList.remove('filtered-out');return;}
        // Evaluate first condition
        let result=evalCondition(tr.cells[conditions[0].col]?.textContent||'',conditions[0].op,conditions[0].val);
        // Chain remaining conditions with their logic
        for(let i=1;i<conditions.length;i++){
            const cond=conditions[i];
            const match=evalCondition(tr.cells[cond.col]?.textContent||'',cond.op,cond.val);
            if(cond.logic==='AND')result=result&&match;
            else if(cond.logic==='OR')result=result||match;
            else if(cond.logic==='NOT')result=result&&!match;
        }
        tr.classList.toggle('filtered-out',!result);
    });
    updateRowCounts();showToast(`${tid} filter applied`);
}

// SORTING
function setupSort(){$$('th').forEach(th=>th.onclick=()=>{const t=th.closest('table'),ci=+th.dataset.col,id=t.id;const dir=sortState[id]?.col===ci&&sortState[id].dir==='asc'?'desc':'asc';sortState[id]={col:ci,dir};t.querySelectorAll('th').forEach(x=>x.classList.remove('sorted','asc','desc'));th.classList.add('sorted',dir);const rows=[...t.querySelectorAll('tbody tr')];rows.sort((a,b)=>{let va=a.cells[ci].textContent,vb=b.cells[ci].textContent;const na=parseFloat(va.replace(/[^0-9.-]/g,'')),nb=parseFloat(vb.replace(/[^0-9.-]/g,''));if(!isNaN(na)&&!isNaN(nb))return dir==='asc'?na-nb:nb-na;return dir==='asc'?va.localeCompare(vb):vb.localeCompare(va);});rows.forEach(r=>t.querySelector('tbody').appendChild(r));});}

// EXPORT
function getTableData(tid){const t=$(`#${tid}`);return{h:[...t.querySelectorAll('th')].map(x=>x.textContent.replace('â†•','').trim()),r:[...t.querySelectorAll('tbody tr')].filter(x=>!x.classList.contains('filtered-out')).map(r=>[...r.cells].map(c=>c.textContent))};}
function exportTable(tid,fmt){
    const{h,r}=getTableData(tid);let content,ext;
    if(fmt==='json'){content=JSON.stringify(r.map(row=>Object.fromEntries(h.map((k,i)=>[k,row[i]]))),null,2);ext='json';}
    else if(fmt==='csv'){content=[h.join(','),...r.map(row=>row.map(c=>`"${c.replace(/"/g,'""')}"`).join(','))].join('\n');ext='csv';}
    else if(fmt==='tsv'){content=[h.join('\t'),...r.map(row=>row.join('\t'))].join('\n');ext='tsv';}
    else{content=`|${h.join('|')}|\n|${h.map(()=>'---').join('|')}|\n${r.map(row=>`|${row.join('|')}|`).join('\n')}`;ext='md';}
    const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([content]));a.download=`${tid}.${ext}`;a.click();closeAllDD();showToast(`Exported ${fmt.toUpperCase()}`);
}
function resetTable(tid){
    const t=$(`#${tid}`);
    [...t.querySelectorAll('tbody tr')].forEach(r=>r.classList.remove('filtered-out','highlight'));
    // Clear filter conditions
    if(tableFilters[tid]){tableFilters[tid].conditions=[];$(`#filter-rows-${tid}`).innerHTML='';}
    delete sortState[tid];
    t.querySelectorAll('th').forEach(x=>x.classList.remove('sorted','asc','desc'));
    updateRowCounts();showToast(`${tid} reset`);
}
function updateRowCounts(){$$('table').forEach(t=>{const el=$(`#count-${t.id}`);if(el)el.textContent=[...t.querySelectorAll('tbody tr')].filter(r=>!r.classList.contains('filtered-out')).length;});}

// DROPDOWNS
function toggleDropdown(id){const el=$(`#${id}`);const was=el.classList.contains('open');closeAllDD();if(!was)el.classList.add('open');}
function closeAllDD(){$$('.dropdown,.export-dropdown').forEach(d=>d.classList.remove('open'));}
document.onclick=e=>{if(!e.target.closest('.dropdown,.export-dropdown'))closeAllDD();};

// TABLE SELECTOR
function buildMenu(){
    const m=$('#tableMenu');
    m.innerHTML='<div class="dropdown-item"><input type="checkbox" id="chkAll"><span><b>All Tables</b></span></div>';
    $$('.table-section').forEach(s=>{
        const id=s.id.replace('sec-','');
        const t=s.querySelector('h3')?.textContent||id;
        // Find metadata alias for this table
        const alias=Object.entries(tableMeta).find(([k,v])=>v===id&&k.length<=3&&isNaN(k))?.[0]||'';
        m.innerHTML+=`<div class="dropdown-item"><input type="checkbox" data-sec="${s.id}"><span>${t}</span><code>${id}${alias?' / '+alias:''}</code></div>`;
    });
    // Fix: Properly bind All Tables checkbox
    const chkAll=$('#chkAll');
    chkAll.onclick=e=>{
        e.stopPropagation();
        const isChecked=chkAll.checked;
        $$('#tableMenu input[data-sec]').forEach(c=>{
            c.checked=isChecked;
            $(`#${c.dataset.sec}`)?.classList.toggle('visible',isChecked);
        });
    };
    $$('#tableMenu input[data-sec]').forEach(c=>{
        c.onclick=e=>e.stopPropagation();
        c.onchange=()=>{
            $(`#${c.dataset.sec}`)?.classList.toggle('visible',c.checked);
            // Update All checkbox state
            const allChecked=[...$$('#tableMenu input[data-sec]')].every(x=>x.checked);
            const noneChecked=[...$$('#tableMenu input[data-sec]')].every(x=>!x.checked);
            chkAll.checked=allChecked;
            chkAll.indeterminate=!allChecked&&!noneChecked;
        };
    });
}
function toggleTbl(c){$(`#${c.dataset.sec}`)?.classList.toggle('visible',c.checked);}

// TOAST
function showToast(msg){const t=$('#toast');$('#toastMsg').textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2500);}

// REFERENCE SYSTEM
const tooltip=$('#tooltip'),modal=$('#modal');
function parseRef(ref){const m=ref.match(/([IR])\(([^,]+),([^,)]+)(?:,([^)]+))?\)/);if(!m)return null;const[_,type,tRef,rowStr,colStr]=m;
// Resolve table reference using metadata
const tKey=tRef.trim();
const tableId=tableMeta[tKey]||tableMeta[tKey.toUpperCase()]||$(`#T${tKey}`)?.id||$$('table')[parseInt(tKey)-1]?.id;
const expand=(s,num)=>{if(!s)return{v:null,g:[],c:false};if(s.toLowerCase()==='all')return{v:['all'],isAll:true,g:[],c:false};const g=[],v=[];s.split('+').forEach(p=>{if(p.includes('*')){const st=v.length;p.split('*').forEach(x=>v.push(...expR(x,num)));g.push({s:st,e:v.length-1});}else v.push(...expR(p,num));});return{v,g,c:g.length>0};};
const expR=(p,num)=>{if(!p.includes('-'))return[p.trim()];const[a,b]=p.split('-').map(x=>x.trim());if(num){const arr=[];for(let i=+a;i<=+b;i++)arr.push(String(i).padStart(a.length,'0'));return arr;}const ma=a.match(/^(.*?)(\d+)$/),mb=b.match(/^(.*?)(\d+)$/);if(ma&&mb&&ma[1]===mb[1]){const arr=[];for(let i=+ma[2];i<=+mb[2];i++)arr.push(ma[1]+String(i).padStart(ma[2].length,'0'));return arr;}return[p];};
const rows=expand(rowStr,type==='R'),cols=expand(colStr,true);return{tableId,type,rows,cols:cols.v?.map(Number),isAllCols:cols.isAll};}
function findRows(p){const t=$(`#${p.tableId}`);if(!t)return[];const tb=t.querySelector('tbody');if(p.rows.isAll)return[...tb.rows].map(r=>({row:r,val:r.cells[0]?.textContent}));return p.rows.v.map(v=>{const row=p.type==='R'?tb.rows[+v-1]:[...tb.rows].find(r=>r.cells[0]?.textContent===v);return row?{row,val:v}:null;}).filter(Boolean);}
function getContent(link){const p=parseRef(link.dataset.ref),rd=findRows(p);if(!rd.length)return{p,d:[]};const h=[...$(`#${p.tableId}`).querySelectorAll('th')].map(x=>x.textContent.replace('â†•','').trim());return{p,d:rd.map(({row,val})=>({id:val,cols:p.cols?p.cols.map(c=>({h:h[c-1],v:row.cells[c-1]?.textContent})):p.isAllCols?[...row.cells].map((cell,i)=>({h:h[i],v:cell.textContent})):[{h:h[1],v:row.cells[1]?.textContent}]}))};}
function showTooltip(e,link){const{d}=getContent(link);if(!d.length)return;let html=d.length===1&&d[0].cols.length===1?d[0].cols[0].v:d.map(x=>`<div class="tooltip-row">${x.id}</div>${x.cols.map(c=>`<div class="tooltip-col">${c.h}: ${c.v}</div>`).join('')}`).join('');tooltip.innerHTML=html;tooltip.style.cssText=`display:block;left:${Math.min(e.clientX,innerWidth-420)}px;top:${e.clientY+15}px`;}
function showModal(link){const{p,d}=getContent(link);if(!d.length)return;$$('tr').forEach(r=>r.classList.remove('highlight'));$$('td').forEach(x=>x.classList.remove('highlight-cell'));let html='';d.forEach(x=>{const row=findRows(p).find(r=>r.val===x.id)?.row;row?.classList.add('highlight');if(p.cols)p.cols.forEach(c=>row?.cells[c-1]?.classList.add('highlight-cell'));else if(p.isAllCols)[...row?.cells||[]].forEach(c=>c.classList.add('highlight-cell'));html+=`<div class="detail-group"><div class="detail-group-title">${x.id}</div>${x.cols.map(c=>`<div class="detail-row highlighted"><span class="detail-label">${c.h}:</span> ${c.v}</div>`).join('')}</div>`;});$('#modalTitle').textContent=d.length===1?`Details: ${d[0].id}`:`Compare: ${d.map(x=>x.id).join(' & ')}`;$('#modalContent').innerHTML=html;modal.classList.add('active');}
function closeModal(){modal.classList.remove('active');$$('tr').forEach(r=>r.classList.remove('highlight'));$$('td').forEach(x=>x.classList.remove('highlight-cell'));}
function autoLink(el){const w=document.createTreeWalker(el,NodeFilter.SHOW_TEXT);const nodes=[];while(w.nextNode())nodes.push(w.currentNode);nodes.forEach(n=>{const t=n.textContent,pat=/([IR]\([^)]+\))/g;if(!pat.test(t))return;const frag=document.createDocumentFragment();let last=0,m;pat.lastIndex=0;while((m=pat.exec(t))){if(m.index>last)frag.appendChild(document.createTextNode(t.slice(last,m.index)));const a=document.createElement('a');a.className='link';a.dataset.ref=m[1];a.textContent=m[1];a.href='#';frag.appendChild(a);last=m.index+m[0].length;}if(last<t.length)frag.appendChild(document.createTextNode(t.slice(last)));n.parentNode.replaceChild(frag,n);});}
function setupLinks(){$$('.link').forEach(l=>{l.onmouseenter=e=>showTooltip(e,l);l.onmouseleave=()=>tooltip.style.display='none';l.onclick=e=>{e.preventDefault();showModal(l);};});}

// INIT
document.addEventListener('DOMContentLoaded',()=>{$$('.auto-link').forEach(autoLink);setupLinks();buildMenu();setupSort();updateRowCounts();});
</script>
</body>
</html>
